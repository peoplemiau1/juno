# HTTPS support via system curl/wget
# Simple wrapper that executes curl and captures output

module BuiltinHTTPS
  def setup_https_data
    return if @https_data_setup
    @https_data_setup = true
    
    @linker.add_data("bin_sh", "/bin/sh\x00")
    @linker.add_data("sh_c", "-c\x00")
    @linker.add_data("https_buf", "\x00" * 8192)
    @linker.add_data("curl_path", "/usr/bin/curl\x00")
    @linker.add_data("curl_s", "-s\x00")
    @linker.add_data("curl_L", "-L\x00")
    @linker.add_data("curl_X", "-X\x00")
    @linker.add_data("curl_POST", "POST\x00")
    @linker.add_data("curl_d", "-d\x00")
    @linker.add_data("curl_H", "-H\x00")
    @linker.add_data("curl_json", "Content-Type: application/json\x00")
  end

  def gen_curl_get(node)
    return unless @target_os == :linux
    setup_https_data
    @emitter.emit([0x41, 0x54, 0x41, 0x55, 0x41, 0x56, 0x41, 0x57]) # push r12-r15
    eval_expression(node[:args][0]); @emitter.push_reg(0) # url
    @emitter.pop_reg(12) # r12 = url
    
    @emitter.emit([0x48, 0x83, 0xec, 0x10, 0x48, 0x89, 0xe7, 0xb8, 0x16, 0,0,0, 0x0f, 0x05, 0xb8, 0x39, 0,0,0, 0x0f, 0x05, 0x48, 0x85, 0xc0])
    child_jmp = @emitter.current_pos
    @emitter.emit([0x0f, 0x84, 0,0,0,0])
    
    # PARENT
    @emitter.emit([0x8b, 0x7c, 0x24, 0x04, 0xb8, 0x03, 0,0,0, 0x0f, 0x05, 0x8b, 0x3c, 0x24, 0x48, 0x8d, 0x35])
    @linker.add_data_patch(@emitter.current_pos, "https_buf")
    @emitter.emit([0,0,0,0, 0xba, 0,0x20,0,0, 0xb8, 0,0,0,0, 0x0f, 0x05, 0x8b, 0x3c, 0x24, 0xb8, 0x03, 0,0,0, 0x0f, 0x05])
    @emitter.emit([0x48, 0xc7, 0xc7, 0xff, 0xff, 0xff, 0xff, 0x48, 0x8d, 0x74, 0x24, 0x08, 0x31, 0xd2, 0x4d, 0x31, 0xd2, 0xb8, 0x3d, 0,0,0, 0x0f, 0x05])
    @emitter.emit([0x48, 0x8d, 0x05])
    @linker.add_data_patch(@emitter.current_pos, "https_buf")
    @emitter.emit([0,0,0,0, 0x48, 0x83, 0xc4, 0x10])
    parent_end = @emitter.current_pos
    @emitter.emit([0xe9, 0,0,0,0])
    
    # CHILD
    child_addr = @emitter.current_pos
    @emitter.bytes[child_jmp+2, 4] = [child_addr - child_jmp - 6].pack("l<").bytes
    @emitter.emit([0x8b, 0x7c, 0x24, 0x04, 0xbe, 0x01, 0,0,0, 0xb8, 0x21, 0,0,0, 0x0f, 0x05, 0x48, 0x83, 0xec, 0x30])
    @emitter.emit([0x48, 0x8d, 0x05])
    @linker.add_data_patch(@emitter.current_pos, "curl_path")
    @emitter.emit([0,0,0,0, 0x48, 0x89, 0x04, 0x24, 0x48, 0x8d, 0x05])
    @linker.add_data_patch(@emitter.current_pos, "curl_s")
    @emitter.emit([0,0,0,0, 0x48, 0x89, 0x44, 0x24, 0x08, 0x4c, 0x89, 0x64, 0x24, 0x10, 0x48, 0xc7, 0x44, 0x24, 0x18, 0,0,0,0])
    @emitter.emit([0x48, 0x8d, 0x3d])
    @linker.add_data_patch(@emitter.current_pos, "curl_path")
    @emitter.emit([0,0,0,0, 0x48, 0x89, 0xe6, 0x48, 0x31, 0xd2, 0xb8, 0x3b, 0,0,0, 0x0f, 0x05])
    
    end_addr = @emitter.current_pos
    @emitter.bytes[parent_end+1, 4] = [end_addr - parent_end - 5].pack("l<").bytes
    @emitter.emit([0x41, 0x5f, 0x41, 0x5e, 0x41, 0x5d, 0x41, 0x5c]) # pop r12-r15
  end

  def gen_https_request(node)
    return unless @target_os == :linux
    setup_https_data
    @emitter.emit([0x41, 0x54, 0x41, 0x55, 0x41, 0x56, 0x41, 0x57]) # push r12-r15
    eval_expression(node[:args][0]); @emitter.push_reg(0) # method
    eval_expression(node[:args][1]); @emitter.push_reg(0) # url
    eval_expression(node[:args][2]); @emitter.push_reg(0) # headers
    eval_expression(node[:args][3]); @emitter.push_reg(0) # data

    @emitter.pop_reg(15) # data
    @emitter.pop_reg(14) # headers
    @emitter.pop_reg(13) # url
    @emitter.pop_reg(12) # method

    @emitter.emit([0x48, 0x83, 0xec, 0x10, 0x48, 0x89, 0xe7, 0xb8, 0x16, 0,0,0, 0x0f, 0x05, 0xb8, 0x39, 0,0,0, 0x0f, 0x05, 0x48, 0x85, 0xc0])
    child_jmp = @emitter.current_pos
    @emitter.emit([0x0f, 0x84, 0,0,0,0])

    # PARENT
    @emitter.emit([0x8b, 0x7c, 0x24, 0x04, 0xb8, 0x03, 0,0,0, 0x0f, 0x05, 0x8b, 0x3c, 0x24, 0x48, 0x8d, 0x35])
    @linker.add_data_patch(@emitter.current_pos, "https_buf")
    @emitter.emit([0,0,0,0, 0xba, 0,0x20,0,0, 0xb8, 0,0,0,0, 0x0f, 0x05, 0x8b, 0x3c, 0x24, 0xb8, 0x03, 0,0,0, 0x0f, 0x05, 0x48, 0xc7, 0xc7, 0xff, 0xff, 0xff, 0xff, 0x48, 0x8d, 0x74, 0x24, 0x08, 0x31, 0xd2, 0x4d, 0x31, 0xd2, 0xb8, 0x3d, 0,0,0, 0x0f, 0x05])
    @emitter.emit([0x48, 0x8d, 0x05])
    @linker.add_data_patch(@emitter.current_pos, "https_buf")
    @emitter.emit([0,0,0,0, 0x48, 0x83, 0xc4, 0x10])
    parent_end = @emitter.current_pos
    @emitter.emit([0xe9, 0,0,0,0])

    # CHILD
    child_addr = @emitter.current_pos
    @emitter.bytes[child_jmp+2, 4] = [child_addr - child_jmp - 6].pack("l<").bytes
    @emitter.emit([0x8b, 0x7c, 0x24, 0x04, 0xbe, 0x01, 0,0,0, 0xb8, 0x21, 0,0,0, 0x0f, 0x05, 0x48, 0x83, 0xec, 0x60])
    @emitter.emit([0x48, 0x8d, 0x05])
    @linker.add_data_patch(@emitter.current_pos, "curl_path")
    @emitter.emit([0,0,0,0, 0x48, 0x89, 0x04, 0x24, 0x48, 0x8d, 0x05])
    @linker.add_data_patch(@emitter.current_pos, "curl_s")
    @emitter.emit([0,0,0,0, 0x48, 0x89, 0x44, 0x24, 0x08, 0x48, 0x8d, 0x05])
    @linker.add_data_patch(@emitter.current_pos, "curl_X")
    @emitter.emit([0,0,0,0, 0x4c, 0x89, 0x64, 0x24, 0x10, 0x48, 0x8d, 0x05])
    @linker.add_data_patch(@emitter.current_pos, "curl_H")
    @emitter.emit([0,0,0,0, 0x4c, 0x89, 0x74, 0x24, 0x18, 0x48, 0x8d, 0x05])
    @linker.add_data_patch(@emitter.current_pos, "curl_d")
    @emitter.emit([0,0,0,0, 0x4c, 0x89, 0x7c, 0x24, 0x20, 0x4c, 0x89, 0x6c, 0x24, 0x28, 0x48, 0xc7, 0x44, 0x24, 0x30, 0,0,0,0])
    @emitter.emit([0x48, 0x8d, 0x3d])
    @linker.add_data_patch(@emitter.current_pos, "curl_path")
    @emitter.emit([0,0,0,0, 0x48, 0x89, 0xe6, 0x48, 0x31, 0xd2, 0xb8, 0x3b, 0,0,0, 0x0f, 0x05])

    end_addr = @emitter.current_pos
    @emitter.bytes[parent_end+1, 4] = [end_addr - parent_end - 5].pack("l<").bytes
    @emitter.emit([0x41, 0x5f, 0x41, 0x5e, 0x41, 0x5d, 0x41, 0x5c]) # pop r12-r15
  end

  def gen_curl_post(node)
    return unless @target_os == :linux
    setup_https_data
    @emitter.emit([0x41, 0x54, 0x41, 0x55, 0x41, 0x56, 0x41, 0x57]) # push r12-r15
    eval_expression(node[:args][0]); @emitter.push_reg(0) # url
    eval_expression(node[:args][1]); @emitter.push_reg(0) # data

    @emitter.pop_reg(13) # data
    @emitter.pop_reg(12) # url
    
    @emitter.emit([0x48, 0x83, 0xec, 0x10, 0x48, 0x89, 0xe7, 0xb8, 0x16, 0,0,0, 0x0f, 0x05, 0xb8, 0x39, 0,0,0, 0x0f, 0x05, 0x48, 0x85, 0xc0])
    child_jmp = @emitter.current_pos
    @emitter.emit([0x0f, 0x84, 0,0,0,0])
    
    # PARENT
    @emitter.emit([0x8b, 0x7c, 0x24, 0x04, 0xb8, 0x03, 0,0,0, 0x0f, 0x05, 0x8b, 0x3c, 0x24, 0x48, 0x8d, 0x35])
    @linker.add_data_patch(@emitter.current_pos, "https_buf")
    @emitter.emit([0,0,0,0, 0xba, 0,0x20,0,0, 0xb8, 0,0,0,0, 0x0f, 0x05, 0x8b, 0x3c, 0x24, 0xb8, 0x03, 0,0,0, 0x0f, 0x05, 0x48, 0xc7, 0xc7, 0xff, 0xff, 0xff, 0xff, 0x48, 0x8d, 0x74, 0x24, 0x08, 0x31, 0xd2, 0x4d, 0x31, 0xd2, 0xb8, 0x3d, 0,0,0, 0x0f, 0x05])
    @emitter.emit([0x48, 0x8d, 0x05])
    @linker.add_data_patch(@emitter.current_pos, "https_buf")
    @emitter.emit([0,0,0,0, 0x48, 0x83, 0xc4, 0x10])
    parent_end = @emitter.current_pos
    @emitter.emit([0xe9, 0,0,0,0])
    
    # CHILD
    child_addr = @emitter.current_pos
    @emitter.bytes[child_jmp+2, 4] = [child_addr - child_jmp - 6].pack("l<").bytes
    @emitter.emit([0x8b, 0x7c, 0x24, 0x04, 0xbe, 0x01, 0,0,0, 0xb8, 0x21, 0,0,0, 0x0f, 0x05, 0x48, 0x83, 0xec, 0x50])
    @emitter.emit([0x48, 0x8d, 0x05])
    @linker.add_data_patch(@emitter.current_pos, "curl_path")
    @emitter.emit([0,0,0,0, 0x48, 0x89, 0x04, 0x24, 0x48, 0x8d, 0x05])
    @linker.add_data_patch(@emitter.current_pos, "curl_s")
    @emitter.emit([0,0,0,0, 0x48, 0x89, 0x44, 0x24, 0x08, 0x48, 0x8d, 0x05])
    @linker.add_data_patch(@emitter.current_pos, "curl_X")
    @emitter.emit([0,0,0,0, 0x48, 0x8d, 0x05])
    @linker.add_data_patch(@emitter.current_pos, "curl_POST")
    @emitter.emit([0,0,0,0, 0x48, 0x89, 0x44, 0x24, 0x10, 0x48, 0x8d, 0x05])
    @linker.add_data_patch(@emitter.current_pos, "curl_d")
    @emitter.emit([0,0,0,0, 0x48, 0x89, 0x44, 0x24, 0x18, 0x4c, 0x89, 0x6c, 0x24, 0x20, 0x4c, 0x89, 0x64, 0x24, 0x28, 0x48, 0xc7, 0x44, 0x24, 0x30, 0,0,0,0])
    @emitter.emit([0x48, 0x8d, 0x3d])
    @linker.add_data_patch(@emitter.current_pos, "curl_path")
    @emitter.emit([0,0,0,0, 0x48, 0x89, 0xe6, 0x48, 0x31, 0xd2, 0xb8, 0x3b, 0,0,0, 0x0f, 0x05])
    
    end_addr = @emitter.current_pos
    @emitter.bytes[parent_end+1, 4] = [end_addr - parent_end - 5].pack("l<").bytes
    @emitter.emit([0x41, 0x5f, 0x41, 0x5e, 0x41, 0x5d, 0x41, 0x5c]) # pop r12-r15
  end
end
