# Внутреннее устройство (Internals)

## Управление памятью и Стек
Juno использует фиксированный размер кадра стека в **256 байт** для каждой функции.

### Разметка стека (от RBP):
- `RBP-0  .. RBP-32`: **Shadow Space**. Резерв для Windows API (RCX, RDX, R8, R9).
- `RBP-33 .. RBP-48`: **Static I/O Buffer**. Используется для конвертации чисел в строки.
- `RBP-64 .. RBP-256`: **User Variables**. Область локальных переменных и структур.

## Соответствие Windows x64 ABI
Компилятор строго соблюдает правила вызова WinAPI:
1. **Выравнивание стека**: Перед каждым `call`, `RSP` выравнивается на 16 байт.
2. **Аргументы**: Первые 4 аргумента передаются через регистры, 5-й и далее — через стек (`[RSP+32]`).
3. **Shadow Space**: Caller всегда выделяет 32 байта перед вызовом.

## Формат файла PE (Portable Executable)
`PEBuilder` генерирует заголовок вручную.
- Секция `.text`: Содержит код и статические данные. Установлены флаги `0xE0000020` (Read/Write/Execute).
- Секция `.idata`: Таблица импорта (IAT) для связи с `kernel32.dll`.

## Математические операции
Поддерживаются базовые операции: `+`, `-`, `*`, `/`. Результат всегда помещается в `RAX`.
Для деления используется `IDIV`, что требует расширения знака в `RDX` через `CQO`.
